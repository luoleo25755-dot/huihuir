<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>我的慧慧日志 · 情侣空间</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="为慧慧打造的粉粉暖暖情侣空间：主页、吃、喜好、习惯、旅游、日历、生理期、我的承诺等，一页应用，支持本地保存/导出。" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .btn { @apply px-3 py-2 rounded-xl text-sm font-medium shadow; }
    .tab { @apply px-3 py-2 rounded-xl border border-pink-200 bg-white/80 hover:bg-pink-50 text-sm; }
    .tab-active { @apply bg-pink-100 border-pink-300 text-pink-900; }
    .card { @apply bg-white/90 backdrop-blur rounded-2xl border border-pink-200 shadow-sm; }
    .pill { @apply inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs bg-pink-100 text-pink-900 border border-pink-200; }
    @media print { .no-print { display:none !important; } body { background:white !important; } }
  </style>
</head>
<body class="bg-gradient-to-br from-pink-50 via-rose-50 to-pink-100 min-h-screen text-slate-800">
  <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Top Bar -->
    <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 rounded-2xl bg-pink-500 text-white grid place-items-center shadow-md">💗</div>
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold text-pink-900">我的慧慧日志 · 情侣空间</h1>
          <p class="text-sm text-pink-700/80">粉粉暖暖的小宇宙 · 仅保存在本地浏览器</p>
        </div>
      </div>
      <div class="no-print flex flex-wrap items-center gap-2">
        <button id="editToggle" class="btn bg-white border border-pink-200 hover:bg-pink-50">进入编辑</button>
        <button id="saveBtn" class="btn bg-pink-600 hover:bg-pink-700 text-white">保存</button>
        <div class="relative">
          <button id="moreBtn" class="btn bg-white border border-pink-200 hover:bg-pink-50">更多</button>
          <div id="moreMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl border border-pink-200 shadow-lg p-2 z-10">
            <button id="exportBtn" class="w-full text-left px-3 py-2 rounded-lg hover:bg-pink-50 text-sm">导出 JSON</button>
            <label class="w-full block text-left px-3 py-2 rounded-lg hover:bg-pink-50 text-sm cursor-pointer">
              导入 JSON<input id="importInput" type="file" accept="application/json" class="hidden" />
            </label>
            <button id="printBtn" class="w-full text-left px-3 py-2 rounded-lg hover:bg-pink-50 text-sm">打印 / 存为 PDF</button>
            <button id="resetBtn" class="w-full text-left px-3 py-2 rounded-lg hover:bg-pink-50 text-sm text-rose-600">清空（本地）</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Meta & Nav -->
    <section class="mt-4 card p-5">
      <div class="grid sm:grid-cols-4 gap-3">
        <div>
          <label class="block text-xs text-slate-500 mb-1">她的名字 / 昵称</label>
          <input id="name" type="text" class="w-full rounded-xl border-pink-200 focus:ring-2 focus:ring-pink-200 focus:border-pink-400" placeholder="例如：慧慧"/>
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">你给她的称呼</label>
          <input id="call" type="text" class="w-full rounded-xl border-pink-200 focus:ring-2 focus:ring-pink-200 focus:border-pink-400" placeholder="例如：小朋友、宝"/>
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">纪念日（YYYY-MM-DD）</label>
          <input id="anniv" type="date" class="w-full rounded-xl border-pink-200 focus:ring-2 focus:ring-pink-200 focus:border-pink-400"/>
        </div>
        <div class="flex items-end gap-2">
          <label class="flex items-center gap-2 text-sm"><input id="annivMode" type="checkbox" class="size-4 rounded border-pink-300"/> 纪念日光效</label>
        </div>
      </div>
      <div class="mt-3 text-xs text-slate-500 flex items-center gap-2">
        <span id="lastSaved">尚未保存</span><span>·</span><span>存储位置：仅浏览器本地</span>
      </div>
      <div class="mt-4 flex flex-wrap gap-2 no-print" id="navTabs"></div>
    </section>

    <!-- Pages -->
    <main id="pages" class="mt-6 grid gap-6"></main>

    <footer class="mt-10 mb-8 text-center text-xs text-pink-700/70">Made with ❤ by 卓卓 · 为慧慧的小日常</footer>
  </div>

  <script>
    // ---------- Data ----------
    const STORAGE_KEY = 'huihui-log-v1';

    const preset = {
      meta: { name: '慧慧', call: '小朋友', anniv: '' },
      duo: { me: '卓卓', her: '慧慧' },
      pages: [
        {
          key: 'home', title: '主页', icon: '🏠',
          blocks: [
            { type: 'text', title: '关于她', hint: '需求与小心愿', items: [ '需求：钱 · 真心 · 爱' ] },
            { type: 'tags', title: '氛围', tags: ['粉粉的','暖暖的','情侣空间'] },
          ]
        },
        {
          key: 'food', title: '吃', icon: '🍱',
          blocks: [
            { type: 'list', title: '她的口味', hint: '口味/偏好/避雷', items: [
              '喜欢：五常大米',
              '喜欢：抹茶味零食',
              '不喜欢：太甜',
              '不喜欢：萝卜',
              '不爱：巧克力',
              '喜欢：麦当当吉士堡',
              '喜欢：寿司',
            ]}
          ]
        },
        {
          key: 'likes', title: '喜好', icon: '🎀',
          blocks: [
            { type: 'list', title: '她可爱的偏好', items: [
              '肥嘟嘟左卫门', '可爱的东西', '纯爱', '三丽鸥', '陈粒的歌'
            ]}
          ]
        },
        {
          key: 'habit', title: '习惯', icon: '🌙',
          blocks: [ { type: 'list', title: '日常习惯', items: [ '刚睡醒没胃口' ] } ]
        },
        {
          key: 'travel', title: '旅游', icon: '🗺️',
          blocks: [ { type: 'list', title: '想去的地方', items: [ '冰岛', '芬兰', '圣彼得堡', '悉尼', '武汉（有三丽鸥店）', '挪威' ] } ]
        },
        {
          key: 'calendar', title: '日历', icon: '📅',
          blocks: [ { type: 'calendar', title: '我们的温柔日历', 
            periodRanges: [ { start: '2025-10-11', end: '2025-10-18', label: '生理期（估）' } ],
            monthlyDays: [ { day: 20, label: '慧慧日', emoji: '💗' } ]
          } ]
        },
        {
          key: 'promise', title: '我的承诺', icon: '🤝',
          blocks: [ { type: 'checklist', title: '卓卓的承诺', items: [
            '给她拍照', '带她做牛排', '带她去旅行', '学调酒（慧慧爱看）'
          ] } ]
        },
      ]
    };

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return preset;
      try { return JSON.parse(raw); } catch { return preset; }
    }
    function save(data){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      const now = new Date();
      document.getElementById('lastSaved').textContent = `已保存 · ${now.toLocaleString()}`;
    }

    // ---------- Render ----------
    const $ = (sel, root=document)=>root.querySelector(sel);
    const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

    let state = load();

    function renderMeta(){
      document.getElementById('name').value = state.meta.name || '';
      document.getElementById('call').value = state.meta.call || '';
      document.getElementById('anniv').value = state.meta.anniv || '';
    }

    function navButton(p){
      const b = document.createElement('button');
      b.className = 'tab';
      b.dataset.page = p.key;
      b.innerHTML = `<span class="mr-1">${p.icon||'⭐'}</span>${p.title}`;
      b.addEventListener('click', ()=>activatePage(p.key));
      return b;
    }

    function renderNav(){
      const nav = document.getElementById('navTabs');
      nav.innerHTML = '';
      state.pages.forEach(p=> nav.appendChild(navButton(p)) );
    }

    function blockHTML(block){
      if(block.type==='text'){
        const items = (block.items||[]).map(t=>`<p class="editable">${t}</p>`).join('');
        return `<div class="card p-5"><h3 class="text-lg font-semibold mb-1">${block.title||''}</h3><p class="text-xs text-pink-700/70 mb-3">${block.hint||''}</p>${items}</div>`;
      }
      if(block.type==='tags'){
        const tags = (block.tags||[]).map(t=>`<span class="pill editable" contenteditable="false">${t}</span>`).join(' ');
        return `<div class="card p-5"><h3 class="text-lg font-semibold mb-2">${block.title||'标签'}</h3><div class="flex flex-wrap gap-2">${tags}</div></div>`;
      }
      if(block.type==='list'){
        const lis = (block.items||[]).map(t=>`<li class="flex items-start gap-2"><span class="mt-1 select-none">•</span><div class="flex-1 editable">${t}</div></li>`).join('');
        return `<div class="card p-5"><h3 class="text-lg font-semibold">${block.title||''}</h3>${block.hint?`<p class='text-xs text-pink-700/70 mb-2'>${block.hint}</p>`:''}<ul class="mt-2 grid gap-2">${lis}</ul></div>`;
      }
      if(block.type==='checklist'){
        const lis = (block.items||[]).map(t=>`<label class="flex items-start gap-2"><input type="checkbox" class="mt-1 rounded border-pink-300"/><span class="flex-1 editable">${t}</span></label>`).join('');
        return `<div class="card p-5"><h3 class="text-lg font-semibold mb-2">${block.title||''}</h3><div class="grid gap-2">${lis}</div></div>`;
      }
      if(block.type==='calendar'){
        return `<div class="card p-5" data-calendar='1'>
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold">${block.title||'日历'}</h3>
            <div class="no-print flex items-center gap-2">
              <button class="tab" data-cal-prev>上个月</button>
              <div class="text-sm" id="calTitle"></div>
              <button class="tab" data-cal-next>下个月</button>
            </div>
          </div>
          <div id="calendar" class="grid grid-cols-7 text-center text-sm select-none"></div>
          <p class="mt-3 text-xs text-pink-700/70">说明：粉色条表示生理期范围；每月 <span class="pill">20日 · 慧慧日 💗</span></p>
        </div>`;
      }
      return '';
    }

    function renderPages(){
      const pages = document.getElementById('pages');
      pages.innerHTML = '';
      state.pages.forEach(p=>{
        const page = document.createElement('section');
        page.id = `page-${p.key}`;
        page.className = 'grid gap-4';
        page.dataset.page = p.key;
        page.innerHTML = p.blocks.map(blockHTML).join('');
        pages.appendChild(page);
      });
    }

    function activatePage(key){
      $$('#navTabs .tab').forEach(b=> b.classList.toggle('tab-active', b.dataset.page===key));
      $$('#pages [data-page]').forEach(sec=> sec.classList.toggle('hidden', sec.dataset.page!==key));
      if(key==='calendar') initCalendar();
      sessionStorage.setItem('activePage', key);
    }

    // ---------- Calendar ----------
    let calView = { y: new Date().getFullYear(), m: new Date().getMonth() }; // m: 0-11

    function getCalendarBlock(){
      const calPage = state.pages.find(p=>p.key==='calendar');
      return calPage?.blocks?.find(b=>b.type==='calendar') || { periodRanges: [], monthlyDays: [] };
    }

    function formatYMD(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }

    function inRanges(dateStr, ranges){
      const t = new Date(dateStr).getTime();
      for(const r of ranges){
        const s = new Date(r.start).getTime();
        const e = new Date(r.end).getTime();
        if(t>=s && t<=e) return r;
      }
      return null;
    }

    function initCalendar(){
      const block = getCalendarBlock();
      const root = document.getElementById('calendar');
      const title = document.getElementById('calTitle');
      root.innerHTML = '';
      const first = new Date(calView.y, calView.m, 1);
      const last = new Date(calView.y, calView.m+1, 0);
      title.textContent = `${calView.y}年 ${calView.m+1}月`;

      // Week headers
      const weeks = ['一','二','三','四','五','六','日'];
      weeks.forEach(w=>{
        const el = document.createElement('div');
        el.className = 'py-1 text-pink-900 font-medium';
        el.textContent = w;
        root.appendChild(el);
      });

      const startPad = (first.getDay()+6)%7; // Monday first
      for(let i=0;i<startPad;i++){ const d=document.createElement('div'); d.className='py-3'; root.appendChild(d); }

      const todayStr = formatYMD(new Date());
      for(let day=1; day<=last.getDate(); day++){
        const d = new Date(calView.y, calView.m, day);
        const ds = formatYMD(d);
        const cell = document.createElement('div');
        cell.className = 'relative py-3 border border-pink-100/70 bg-white/70';
        const inR = inRanges(ds, block.periodRanges||[]);
        if(inR){ cell.classList.add('bg-pink-100'); }
        const md = (block.monthlyDays||[]).find(x=>x.day===day);
        cell.innerHTML = `<div class="text-sm ${ds===todayStr?'font-bold text-pink-700':''}">${day}${md?` <span title="${md.label}" class="align-middle">${md.emoji||'🌸'}</span>`:''}</div>`;
        if(md){
          const tag = document.createElement('div');
          tag.className = 'absolute left-1 right-1 bottom-1 text-[10px] text-pink-700/80 truncate';
          tag.textContent = md.label;
          cell.appendChild(tag);
        }
        if(inR){
          const bar = document.createElement('div');
          bar.className = 'absolute inset-x-1 bottom-0 h-1 rounded bg-pink-400';
          cell.appendChild(bar);
        }
        root.appendChild(cell);
      }

      // Nav
      $('[data-cal-prev]')?.addEventListener('click', ()=>{ calView.m--; if(calView.m<0){calView.m=11; calView.y--; } initCalendar(); });
      $('[data-cal-next]')?.addEventListener('click', ()=>{ calView.m++; if(calView.m>11){calView.m=0; calView.y++; } initCalendar(); });
    }

    // ---------- Edit Mode ----------
    let editMode = false;
    function setEditMode(v){
      editMode = !!v;
      document.getElementById('editToggle').textContent = editMode ? '退出编辑' : '进入编辑';
      $$('.editable').forEach(el=>{
        el.setAttribute('contenteditable', editMode ? 'true':'false');
        el.classList.toggle('ring-1', editMode);
        el.classList.toggle('ring-pink-200', editMode);
        el.classList.toggle('bg-white', editMode);
      });
    }

    function collect(){
      const data = structuredClone(state);
      data.meta.name = document.getElementById('name').value.trim();
      data.meta.call = document.getElementById('call').value.trim();
      data.meta.anniv = document.getElementById('anniv').value;
      // collect editable texts
      $$('#pages [data-page]').forEach(sec=>{
        const page = data.pages.find(p=>p.key===sec.dataset.page);
        if(!page) return;
        let idx = 0;
        page.blocks = page.blocks.map(b=>{
          if(['text','list','checklist'].includes(b.type)){
            const eds = $$('.editable', sec).slice(idx);
            const count = (b.type==='list'||b.type==='checklist') ? (b.items?.length||0) : (b.items?.length||0);
            const items = [];
            for(let i=0;i<count;i++){ items.push(eds[i]?.textContent?.trim()||''); }
            idx += count;
            return { ...b, items };
          }
          return b;
        });
      });
      return data;
    }

    // ---------- Init ----------
    function renderAll(){
      renderMeta();
      renderNav();
      renderPages();
      setEditMode(false);
      const active = sessionStorage.getItem('activePage') || 'home';
      activatePage(active);
      if(localStorage.getItem(STORAGE_KEY)){
        document.getElementById('lastSaved').textContent = '已从本地载入';
      }
    }

    renderAll();

    // ---------- Events ----------
    document.addEventListener('click', (e)=>{
      const t = e.target;
      if(t.id==='editToggle') setEditMode(!editMode);
      else if(t.id==='saveBtn') save(collect());
      else if(t.id==='moreBtn') $('#moreMenu').classList.toggle('hidden');
      else if(t.id==='printBtn') window.print();
      else if(t.id==='exportBtn'){
        const blob = new Blob([JSON.stringify(collect(), null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = `huihui-log-${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href);
      }
      else if(t.id==='resetBtn'){
        if(confirm('确定清空本地存储并恢复预设吗？')){ localStorage.removeItem(STORAGE_KEY); state = structuredClone(preset); renderAll(); }
      }
    });

    document.addEventListener('click', (e)=>{
      if(!$('#moreMenu')) return; if(e.target.id==='moreBtn') return; if(!$('#moreMenu').contains(e.target)) $('#moreMenu').classList.add('hidden');
    }, true);

    document.getElementById('importInput').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return; const r = new FileReader();
      r.onload = ()=>{ try{ state = JSON.parse(r.result); save(state); renderAll(); }catch{ alert('导入失败：JSON 格式不正确'); } };
      r.readAsText(f); e.target.value=''; $('#moreMenu').classList.add('hidden');
    });

    ;['name','call','anniv'].forEach(id=> document.getElementById(id).addEventListener('change', ()=>{ document.getElementById('lastSaved').textContent = '有未保存的更改…'; }));

    document.getElementById('annivMode').addEventListener('change', (e)=>{
      document.body.classList.toggle('bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))]', e.target.checked);
    });
  </script>
</body>
</html>
