<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ‘çš„æ…§æ…§æ—¥å¿— Â· æƒ…ä¾£ç©ºé—´</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="ä¸ºæ…§æ…§æ‰“é€ çš„ç²‰ç²‰æš–æš–æƒ…ä¾£ç©ºé—´ï¼šä¸»é¡µã€åƒã€å–œå¥½ã€ä¹ æƒ¯ã€æ—…æ¸¸ã€æ—¥å†ã€ç”Ÿç†æœŸã€æˆ‘çš„æ‰¿è¯ºç­‰ï¼Œä¸€é¡µåº”ç”¨ï¼Œæ”¯æŒæœ¬åœ°ä¿å­˜/å¯¼å‡ºã€‚" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .btn { @apply px-3 py-2 rounded-xl text-sm font-medium shadow; }
    .tab { @apply px-3 py-2 rounded-xl border border-pink-200 bg-white/80 hover:bg-pink-50 text-sm; }
    .tab-active { @apply bg-pink-100 border-pink-300 text-pink-900; }
    .card { @apply bg-white/90 backdrop-blur rounded-2xl border border-pink-200 shadow-sm; }
    .pill { @apply inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs bg-pink-100 text-pink-900 border border-pink-200; }
    @media print { .no-print { display:none !important; } body { background:white !important; } }
  </style>
</head>
<body class="bg-gradient-to-br from-pink-50 via-rose-50 to-pink-100 min-h-screen text-slate-800">
  <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Top Bar -->
    <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 rounded-2xl bg-pink-500 text-white grid place-items-center shadow-md">ğŸ’—</div>
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold text-pink-900">æˆ‘çš„æ…§æ…§æ—¥å¿— Â· æƒ…ä¾£ç©ºé—´</h1>
          <p class="text-sm text-pink-700/80">ç²‰ç²‰æš–æš–çš„å°å®‡å®™ Â· ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨</p>
        </div>
      </div>
      <div class="no-print flex flex-wrap items-center gap-2">
        <button id="editToggle" class="btn bg-white border border-pink-200 hover:bg-pink-50">è¿›å…¥ç¼–è¾‘</button>
        <button id="saveBtn" class="btn bg-pink-600 hover:bg-pink-700 text-white">ä¿å­˜</button>
        <div class="relative">
          <button id="moreBtn" class="btn bg-white border border-pink-200 hover:bg-pink-50">æ›´å¤š</button>
          <div id="moreMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl border border-pink-200 shadow-lg p-2 z-10">
            <button id="exportBtn" class="w-full text-left px-3 py-2 rounded-lg hover:bg-pink-50 text-sm">å¯¼å‡º JSON</button>
            <label class="w-full block text-left px-3 py-2 rounded-lg hover:bg-pink-50 text-sm cursor-pointer">
              å¯¼å…¥ JSON<input id="importInput" type="file" accept="application/json" class="hidden" />
            </label>
            <button id="printBtn" class="w-full text-left px-3 py-2 rounded-lg hover:bg-pink-50 text-sm">æ‰“å° / å­˜ä¸º PDF</button>
            <button id="resetBtn" class="w-full text-left px-3 py-2 rounded-lg hover:bg-pink-50 text-sm text-rose-600">æ¸…ç©ºï¼ˆæœ¬åœ°ï¼‰</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Meta & Nav -->
    <section class="mt-4 card p-5">
      <div class="grid sm:grid-cols-4 gap-3">
        <div>
          <label class="block text-xs text-slate-500 mb-1">å¥¹çš„åå­— / æ˜µç§°</label>
          <input id="name" type="text" class="w-full rounded-xl border-pink-200 focus:ring-2 focus:ring-pink-200 focus:border-pink-400" placeholder="ä¾‹å¦‚ï¼šæ…§æ…§"/>
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">ä½ ç»™å¥¹çš„ç§°å‘¼</label>
          <input id="call" type="text" class="w-full rounded-xl border-pink-200 focus:ring-2 focus:ring-pink-200 focus:border-pink-400" placeholder="ä¾‹å¦‚ï¼šå°æœ‹å‹ã€å®"/>
        </div>
        <div>
          <label class="block text-xs text-slate-500 mb-1">çºªå¿µæ—¥ï¼ˆYYYY-MM-DDï¼‰</label>
          <input id="anniv" type="date" class="w-full rounded-xl border-pink-200 focus:ring-2 focus:ring-pink-200 focus:border-pink-400"/>
        </div>
        <div class="flex items-end gap-2">
          <label class="flex items-center gap-2 text-sm"><input id="annivMode" type="checkbox" class="size-4 rounded border-pink-300"/> çºªå¿µæ—¥å…‰æ•ˆ</label>
        </div>
      </div>
      <div class="mt-3 text-xs text-slate-500 flex items-center gap-2">
        <span id="lastSaved">å°šæœªä¿å­˜</span><span>Â·</span><span>å­˜å‚¨ä½ç½®ï¼šä»…æµè§ˆå™¨æœ¬åœ°</span>
      </div>
      <div class="mt-4 flex flex-wrap gap-2 no-print" id="navTabs"></div>
    </section>

    <!-- Pages -->
    <main id="pages" class="mt-6 grid gap-6"></main>

    <footer class="mt-10 mb-8 text-center text-xs text-pink-700/70">Made with â¤ by å“å“ Â· ä¸ºæ…§æ…§çš„å°æ—¥å¸¸</footer>
  </div>

  <script>
    // ---------- Data ----------
    const STORAGE_KEY = 'huihui-log-v1';

    const preset = {
      meta: { name: 'æ…§æ…§', call: 'å°æœ‹å‹', anniv: '' },
      duo: { me: 'å“å“', her: 'æ…§æ…§' },
      pages: [
        {
          key: 'home', title: 'ä¸»é¡µ', icon: 'ğŸ ',
          blocks: [
            { type: 'text', title: 'å…³äºå¥¹', hint: 'éœ€æ±‚ä¸å°å¿ƒæ„¿', items: [ 'éœ€æ±‚ï¼šé’± Â· çœŸå¿ƒ Â· çˆ±' ] },
            { type: 'tags', title: 'æ°›å›´', tags: ['ç²‰ç²‰çš„','æš–æš–çš„','æƒ…ä¾£ç©ºé—´'] },
          ]
        },
        {
          key: 'food', title: 'åƒ', icon: 'ğŸ±',
          blocks: [
            { type: 'list', title: 'å¥¹çš„å£å‘³', hint: 'å£å‘³/åå¥½/é¿é›·', items: [
              'å–œæ¬¢ï¼šäº”å¸¸å¤§ç±³',
              'å–œæ¬¢ï¼šæŠ¹èŒ¶å‘³é›¶é£Ÿ',
              'ä¸å–œæ¬¢ï¼šå¤ªç”œ',
              'ä¸å–œæ¬¢ï¼šèåœ',
              'ä¸çˆ±ï¼šå·§å…‹åŠ›',
              'å–œæ¬¢ï¼šéº¦å½“å½“å‰å£«å ¡',
              'å–œæ¬¢ï¼šå¯¿å¸',
            ]}
          ]
        },
        {
          key: 'likes', title: 'å–œå¥½', icon: 'ğŸ€',
          blocks: [
            { type: 'list', title: 'å¥¹å¯çˆ±çš„åå¥½', items: [
              'è‚¥å˜Ÿå˜Ÿå·¦å«é—¨', 'å¯çˆ±çš„ä¸œè¥¿', 'çº¯çˆ±', 'ä¸‰ä¸½é¸¥', 'é™ˆç²’çš„æ­Œ'
            ]}
          ]
        },
        {
          key: 'habit', title: 'ä¹ æƒ¯', icon: 'ğŸŒ™',
          blocks: [ { type: 'list', title: 'æ—¥å¸¸ä¹ æƒ¯', items: [ 'åˆšç¡é†’æ²¡èƒƒå£' ] } ]
        },
        {
          key: 'travel', title: 'æ—…æ¸¸', icon: 'ğŸ—ºï¸',
          blocks: [ { type: 'list', title: 'æƒ³å»çš„åœ°æ–¹', items: [ 'å†°å²›', 'èŠ¬å…°', 'åœ£å½¼å¾—å ¡', 'æ‚‰å°¼', 'æ­¦æ±‰ï¼ˆæœ‰ä¸‰ä¸½é¸¥åº—ï¼‰', 'æŒªå¨' ] } ]
        },
        {
          key: 'calendar', title: 'æ—¥å†', icon: 'ğŸ“…',
          blocks: [ { type: 'calendar', title: 'æˆ‘ä»¬çš„æ¸©æŸ”æ—¥å†', 
            periodRanges: [ { start: '2025-10-11', end: '2025-10-18', label: 'ç”Ÿç†æœŸï¼ˆä¼°ï¼‰' } ],
            monthlyDays: [ { day: 20, label: 'æ…§æ…§æ—¥', emoji: 'ğŸ’—' } ]
          } ]
        },
        {
          key: 'promise', title: 'æˆ‘çš„æ‰¿è¯º', icon: 'ğŸ¤',
          blocks: [ { type: 'checklist', title: 'å“å“çš„æ‰¿è¯º', items: [
            'ç»™å¥¹æ‹ç…§', 'å¸¦å¥¹åšç‰›æ’', 'å¸¦å¥¹å»æ—…è¡Œ', 'å­¦è°ƒé…’ï¼ˆæ…§æ…§çˆ±çœ‹ï¼‰'
          ] } ]
        },
      ]
    };

    function load(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return preset;
      try { return JSON.parse(raw); } catch { return preset; }
    }
    function save(data){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      const now = new Date();
      document.getElementById('lastSaved').textContent = `å·²ä¿å­˜ Â· ${now.toLocaleString()}`;
    }

    // ---------- Render ----------
    const $ = (sel, root=document)=>root.querySelector(sel);
    const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

    let state = load();

    function renderMeta(){
      document.getElementById('name').value = state.meta.name || '';
      document.getElementById('call').value = state.meta.call || '';
      document.getElementById('anniv').value = state.meta.anniv || '';
    }

    function navButton(p){
      const b = document.createElement('button');
      b.className = 'tab';
      b.dataset.page = p.key;
      b.innerHTML = `<span class="mr-1">${p.icon||'â­'}</span>${p.title}`;
      b.addEventListener('click', ()=>activatePage(p.key));
      return b;
    }

    function renderNav(){
      const nav = document.getElementById('navTabs');
      nav.innerHTML = '';
      state.pages.forEach(p=> nav.appendChild(navButton(p)) );
    }

    function blockHTML(block){
      if(block.type==='text'){
        const items = (block.items||[]).map(t=>`<p class="editable">${t}</p>`).join('');
        return `<div class="card p-5"><h3 class="text-lg font-semibold mb-1">${block.title||''}</h3><p class="text-xs text-pink-700/70 mb-3">${block.hint||''}</p>${items}</div>`;
      }
      if(block.type==='tags'){
        const tags = (block.tags||[]).map(t=>`<span class="pill editable" contenteditable="false">${t}</span>`).join(' ');
        return `<div class="card p-5"><h3 class="text-lg font-semibold mb-2">${block.title||'æ ‡ç­¾'}</h3><div class="flex flex-wrap gap-2">${tags}</div></div>`;
      }
      if(block.type==='list'){
        const lis = (block.items||[]).map(t=>`<li class="flex items-start gap-2"><span class="mt-1 select-none">â€¢</span><div class="flex-1 editable">${t}</div></li>`).join('');
        return `<div class="card p-5"><h3 class="text-lg font-semibold">${block.title||''}</h3>${block.hint?`<p class='text-xs text-pink-700/70 mb-2'>${block.hint}</p>`:''}<ul class="mt-2 grid gap-2">${lis}</ul></div>`;
      }
      if(block.type==='checklist'){
        const lis = (block.items||[]).map(t=>`<label class="flex items-start gap-2"><input type="checkbox" class="mt-1 rounded border-pink-300"/><span class="flex-1 editable">${t}</span></label>`).join('');
        return `<div class="card p-5"><h3 class="text-lg font-semibold mb-2">${block.title||''}</h3><div class="grid gap-2">${lis}</div></div>`;
      }
      if(block.type==='calendar'){
        return `<div class="card p-5" data-calendar='1'>
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold">${block.title||'æ—¥å†'}</h3>
            <div class="no-print flex items-center gap-2">
              <button class="tab" data-cal-prev>ä¸Šä¸ªæœˆ</button>
              <div class="text-sm" id="calTitle"></div>
              <button class="tab" data-cal-next>ä¸‹ä¸ªæœˆ</button>
            </div>
          </div>
          <div id="calendar" class="grid grid-cols-7 text-center text-sm select-none"></div>
          <p class="mt-3 text-xs text-pink-700/70">è¯´æ˜ï¼šç²‰è‰²æ¡è¡¨ç¤ºç”Ÿç†æœŸèŒƒå›´ï¼›æ¯æœˆ <span class="pill">20æ—¥ Â· æ…§æ…§æ—¥ ğŸ’—</span></p>
        </div>`;
      }
      return '';
    }

    function renderPages(){
      const pages = document.getElementById('pages');
      pages.innerHTML = '';
      state.pages.forEach(p=>{
        const page = document.createElement('section');
        page.id = `page-${p.key}`;
        page.className = 'grid gap-4';
        page.dataset.page = p.key;
        page.innerHTML = p.blocks.map(blockHTML).join('');
        pages.appendChild(page);
      });
    }

    function activatePage(key){
      $$('#navTabs .tab').forEach(b=> b.classList.toggle('tab-active', b.dataset.page===key));
      $$('#pages [data-page]').forEach(sec=> sec.classList.toggle('hidden', sec.dataset.page!==key));
      if(key==='calendar') initCalendar();
      sessionStorage.setItem('activePage', key);
    }

    // ---------- Calendar ----------
    let calView = { y: new Date().getFullYear(), m: new Date().getMonth() }; // m: 0-11

    function getCalendarBlock(){
      const calPage = state.pages.find(p=>p.key==='calendar');
      return calPage?.blocks?.find(b=>b.type==='calendar') || { periodRanges: [], monthlyDays: [] };
    }

    function formatYMD(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }

    function inRanges(dateStr, ranges){
      const t = new Date(dateStr).getTime();
      for(const r of ranges){
        const s = new Date(r.start).getTime();
        const e = new Date(r.end).getTime();
        if(t>=s && t<=e) return r;
      }
      return null;
    }

    function initCalendar(){
      const block = getCalendarBlock();
      const root = document.getElementById('calendar');
      const title = document.getElementById('calTitle');
      root.innerHTML = '';
      const first = new Date(calView.y, calView.m, 1);
      const last = new Date(calView.y, calView.m+1, 0);
      title.textContent = `${calView.y}å¹´ ${calView.m+1}æœˆ`;

      // Week headers
      const weeks = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
      weeks.forEach(w=>{
        const el = document.createElement('div');
        el.className = 'py-1 text-pink-900 font-medium';
        el.textContent = w;
        root.appendChild(el);
      });

      const startPad = (first.getDay()+6)%7; // Monday first
      for(let i=0;i<startPad;i++){ const d=document.createElement('div'); d.className='py-3'; root.appendChild(d); }

      const todayStr = formatYMD(new Date());
      for(let day=1; day<=last.getDate(); day++){
        const d = new Date(calView.y, calView.m, day);
        const ds = formatYMD(d);
        const cell = document.createElement('div');
        cell.className = 'relative py-3 border border-pink-100/70 bg-white/70';
        const inR = inRanges(ds, block.periodRanges||[]);
        if(inR){ cell.classList.add('bg-pink-100'); }
        const md = (block.monthlyDays||[]).find(x=>x.day===day);
        cell.innerHTML = `<div class="text-sm ${ds===todayStr?'font-bold text-pink-700':''}">${day}${md?` <span title="${md.label}" class="align-middle">${md.emoji||'ğŸŒ¸'}</span>`:''}</div>`;
        if(md){
          const tag = document.createElement('div');
          tag.className = 'absolute left-1 right-1 bottom-1 text-[10px] text-pink-700/80 truncate';
          tag.textContent = md.label;
          cell.appendChild(tag);
        }
        if(inR){
          const bar = document.createElement('div');
          bar.className = 'absolute inset-x-1 bottom-0 h-1 rounded bg-pink-400';
          cell.appendChild(bar);
        }
        root.appendChild(cell);
      }

      // Nav
      $('[data-cal-prev]')?.addEventListener('click', ()=>{ calView.m--; if(calView.m<0){calView.m=11; calView.y--; } initCalendar(); });
      $('[data-cal-next]')?.addEventListener('click', ()=>{ calView.m++; if(calView.m>11){calView.m=0; calView.y++; } initCalendar(); });
    }

    // ---------- Edit Mode ----------
    let editMode = false;
    function setEditMode(v){
      editMode = !!v;
      document.getElementById('editToggle').textContent = editMode ? 'é€€å‡ºç¼–è¾‘' : 'è¿›å…¥ç¼–è¾‘';
      $$('.editable').forEach(el=>{
        el.setAttribute('contenteditable', editMode ? 'true':'false');
        el.classList.toggle('ring-1', editMode);
        el.classList.toggle('ring-pink-200', editMode);
        el.classList.toggle('bg-white', editMode);
      });
    }

    function collect(){
      const data = structuredClone(state);
      data.meta.name = document.getElementById('name').value.trim();
      data.meta.call = document.getElementById('call').value.trim();
      data.meta.anniv = document.getElementById('anniv').value;
      // collect editable texts
      $$('#pages [data-page]').forEach(sec=>{
        const page = data.pages.find(p=>p.key===sec.dataset.page);
        if(!page) return;
        let idx = 0;
        page.blocks = page.blocks.map(b=>{
          if(['text','list','checklist'].includes(b.type)){
            const eds = $$('.editable', sec).slice(idx);
            const count = (b.type==='list'||b.type==='checklist') ? (b.items?.length||0) : (b.items?.length||0);
            const items = [];
            for(let i=0;i<count;i++){ items.push(eds[i]?.textContent?.trim()||''); }
            idx += count;
            return { ...b, items };
          }
          return b;
        });
      });
      return data;
    }

    // ---------- Init ----------
    function renderAll(){
      renderMeta();
      renderNav();
      renderPages();
      setEditMode(false);
      const active = sessionStorage.getItem('activePage') || 'home';
      activatePage(active);
      if(localStorage.getItem(STORAGE_KEY)){
        document.getElementById('lastSaved').textContent = 'å·²ä»æœ¬åœ°è½½å…¥';
      }
    }

    renderAll();

    // ---------- Events ----------
    document.addEventListener('click', (e)=>{
      const t = e.target;
      if(t.id==='editToggle') setEditMode(!editMode);
      else if(t.id==='saveBtn') save(collect());
      else if(t.id==='moreBtn') $('#moreMenu').classList.toggle('hidden');
      else if(t.id==='printBtn') window.print();
      else if(t.id==='exportBtn'){
        const blob = new Blob([JSON.stringify(collect(), null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = `huihui-log-${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href);
      }
      else if(t.id==='resetBtn'){
        if(confirm('ç¡®å®šæ¸…ç©ºæœ¬åœ°å­˜å‚¨å¹¶æ¢å¤é¢„è®¾å—ï¼Ÿ')){ localStorage.removeItem(STORAGE_KEY); state = structuredClone(preset); renderAll(); }
      }
    });

    document.addEventListener('click', (e)=>{
      if(!$('#moreMenu')) return; if(e.target.id==='moreBtn') return; if(!$('#moreMenu').contains(e.target)) $('#moreMenu').classList.add('hidden');
    }, true);

    document.getElementById('importInput').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return; const r = new FileReader();
      r.onload = ()=>{ try{ state = JSON.parse(r.result); save(state); renderAll(); }catch{ alert('å¯¼å…¥å¤±è´¥ï¼šJSON æ ¼å¼ä¸æ­£ç¡®'); } };
      r.readAsText(f); e.target.value=''; $('#moreMenu').classList.add('hidden');
    });

    ;['name','call','anniv'].forEach(id=> document.getElementById(id).addEventListener('change', ()=>{ document.getElementById('lastSaved').textContent = 'æœ‰æœªä¿å­˜çš„æ›´æ”¹â€¦'; }));

    document.getElementById('annivMode').addEventListener('change', (e)=>{
      document.body.classList.toggle('bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))]', e.target.checked);
    });
  </script>
</body>
</html>
